<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metronome</title>
</head>
<body>

</body>
<script src="main.js">
</script>
<script>
    const app = Elm.Main.fullscreen();

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const gain = audioCtx.createGain();
    gain.connect(audioCtx.destination);
    let interval = null;
    const setNote = (when) =>{
        const length = 0.1;
        const oscillator = audioCtx.createOscillator();
        oscillator.connect(gain);
        oscillator.start(when);
        oscillator.stop(when + length);
    };
    let timer = null;
    app.ports.newInterval.subscribe((new_interval)=>{
        interval = new_interval;
    });
    app.ports.toggle.subscribe((new_interval)=>{
        interval = new_interval;
        if(timer == null){
            gain.gain.value = 1;
            let last_time = audioCtx.currentTime;
            setNote(last_time);
            timer = setInterval(()=>{
                const until = audioCtx.currentTime + 1;
                const times = getRange(last_time, until, interval);
                last_time = times.slice(-1)[0];
                times.slice(1).forEach((time)=>{
                    setNote(time);
                });
            }, 1);
        } else{
            gain.gain.value = 0;
            clearInterval(timer);
            timer = null;
        }
    });
    function getRange(start, stop, interval){
        const time_list = [];
        let current_time = start;
        while(current_time <= stop){
            time_list.push(current_time);
            current_time += interval;
        }
        return time_list;
    }
</script>

</html>